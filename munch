#!/bin/bash

# Munch version 0.2
# create a bootable iso with persistence
# by Mr Green
# 

# Format your device using Fat32, Ext2/3/4 or Btrfs
# Make sure boot flag is set.
# Run this script in the same directory as iso

set -o nounset

usage()
{
printf "Usage: %s: [sdx] [iso_file_name] \n" $(basename $0) >&2
exit 2
}

# test for 2 items
[ $# -ne 2 ] && usage && exit 2

# Is $1 a block device?
[[ -b /dev/${1} ]] && usb_device=${1} || usage

# Is $2 a valid filename?
[[ -f ${2} ]] && iso_name=${2} || usage

exit

# Path to syslinux
usb_syslinux=/mnt/usb/arch/boot/syslinux

# Iso label requires cdrkit 
#iso_label=$(isoinfo -d -i ${iso_name} |grep "^Volume id"|awk '{print $3}')

mkdir -p /mnt/{usb,iso}
mount -o loop ${iso_name} /mnt/iso
mount ${usb_device}1 /mnt/usb
cp -r /mnt/iso/* /mnt/usb

# New version might be a better way?
x=$(grep -m 1 -i 'archisolabel' ${usb_syslinux}/syslinux.cfg | awk '{print $3}')
iso_label=${x:13}

# Adjust syslinux and create persistence
extlinux --install ${usb_syslinux}
dd bs=440 conv=notrunc count=1 if=/usr/lib/syslinux/mbr.bin of=${usb_device}

# Boot device and create persistence  
usb_uuid="/dev/disk/by-uuid/$(lsblk -no UUID ${usb_device}1)"
sed -i "s|label=${iso_label}|device=${usb_uuid} cow_device=${usb_uuid}|" \
    ${usb_syslinux}/syslinux.cfg

umount /mnt/{usb,iso}
# need to remove usb and iso directories
rmdir /mnt/usb
rmdir /mnt/iso
